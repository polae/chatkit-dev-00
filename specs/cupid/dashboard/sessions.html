<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sessions - Cupid Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Session row styles */
    .session-row {
      cursor: pointer;
    }

    .session-row:hover {
      background: var(--bg-hover);
    }

    .session-id {
      font-family: var(--font-mono);
      font-size: var(--text-sm);
      color: var(--blue);
    }

    .characters {
      font-size: var(--text-sm);
    }

    .no-sessions {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-secondary);
    }

    /* Progress badge styles */
    .progress-badge {
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      white-space: nowrap;
    }

    .progress-badge.complete {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .progress-badge.incomplete {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    /* Details row (expanded) */
    .details-row {
      background: var(--bg-tertiary);
    }

    .details-row td {
      padding: 0;
    }

    .details-grid {
      display: flex;
      gap: var(--spacing-xl);
      padding: var(--spacing-md) var(--spacing-lg);
      padding-left: 48px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-label {
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .detail-value {
      font-size: var(--text-sm);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar Navigation -->
    <nav class="sidebar">
      <a href="index.html" class="nav-logo">
        <span>Cupid</span>
      </a>

      <div class="nav-section">
        <div class="nav-section-title">Observability</div>
        <a href="sessions.html" class="nav-link active">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          Sessions
        </a>
        <a href="agent.html" class="nav-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 2a10 10 0 0 1 10 10H12z"></path></svg>
          Agents
        </a>
        <a href="metrics.html" class="nav-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
          Metrics
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">External</div>
        <a href="https://us.cloud.langfuse.com" target="_blank" class="nav-link">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
          Langfuse Console
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
      <div class="page-header">
        <h1 class="page-title">Sessions</h1>
        <p class="page-subtitle">Browse all game sessions and conversations</p>
      </div>

      <!-- Filters -->
      <div class="filters-bar">
        <div class="filter-group">
          <label class="filter-label">Time Range</label>
          <select class="select" id="time-filter">
            <option value="24h">Last 24 hours</option>
            <option value="7d" selected>Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="filter-group" style="flex: 1;">
          <input type="text" class="input" id="search-input" placeholder="Search by session ID or character name...">
        </div>
        <button class="btn btn-secondary" onclick="loadSessions()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
          Refresh
        </button>
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Sessions</div>
          <div class="kpi-value" id="kpi-sessions">-</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Total Cost</div>
          <div class="kpi-value" id="kpi-cost">-</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Avg Duration</div>
          <div class="kpi-value" id="kpi-duration">-</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Avg Latency</div>
          <div class="kpi-value" id="kpi-latency">-</div>
        </div>
      </div>

      <!-- Sessions Table -->
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width: 30px;"></th>
                <th>Session</th>
                <th>Status</th>
                <th>Characters</th>
                <th>Duration</th>
                <th style="width: 100px;"></th>
              </tr>
            </thead>
            <tbody id="sessions-table">
              <tr>
                <td colspan="6" class="loading">Loading sessions...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script src="api.js"></script>
  <script>
    const api = new LangfuseAPI();
    let sessionsData = [];
    let expandedSession = null;

    // Get progress from session tags (chapter-based)
    function getSessionProgressFromTags(tags) {
      const chapterTags = (tags || []).filter(t => t.startsWith('chapter_'));

      // Check if complete (has chapter 5/6)
      const hasLateChapter = chapterTags.some(ch =>
        ch === 'chapter_5' || ch === 'chapter_6' ||
        parseInt(ch.replace('chapter_', '')) >= 5
      );

      // Get max chapter
      let maxChapter = -1;
      for (const ch of chapterTags) {
        const num = parseInt(ch.replace('chapter_', ''));
        if (!isNaN(num) && num > maxChapter) {
          maxChapter = num;
        }
      }

      const chapterNames = {
        0: 'Intro',
        1: 'Mortal',
        2: 'Match',
        3: 'Compatibility',
        4: 'Story',
        5: 'Evaluation',
        6: 'End'
      };

      if (hasLateChapter) {
        return { label: 'Complete', isComplete: true, chapter: maxChapter };
      }

      if (maxChapter >= 0) {
        const name = chapterNames[maxChapter] || `Ch ${maxChapter}`;
        return { label: name, isComplete: false, chapter: maxChapter };
      }

      return { label: 'Started', isComplete: false, chapter: -1 };
    }

    async function loadSessions() {
      const tbody = document.getElementById('sessions-table');
      tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading sessions...</td></tr>';

      try {
        // Use existing getUsersWithSessions but flatten to session list
        const result = await api.getUsersWithSessions();

        // Flatten: each "user" has one session, extract session with computed stats
        sessionsData = result.data.map(user => {
          const session = user.sessions[0]; // 1:1 relationship
          return {
            sessionId: session.id,
            mortal: session.mortal,
            match: session.match,
            tags: session.tags,
            totalCost: user.totalCost,
            avgLatency: user.avgLatency,
            firstSeen: user.firstSeen,
            lastActive: user.lastActive,
            traceCount: user.traceCount
          };
        });

        // Update KPIs
        const totalCost = sessionsData.reduce((sum, s) => sum + s.totalCost, 0);
        const avgLatency = sessionsData.length > 0
          ? sessionsData.reduce((sum, s) => sum + s.avgLatency, 0) / sessionsData.length
          : 0;

        // Calculate average duration
        let totalDuration = 0;
        sessionsData.forEach(s => {
          if (s.firstSeen && s.lastActive) {
            totalDuration += new Date(s.lastActive) - new Date(s.firstSeen);
          }
        });
        const avgDuration = sessionsData.length > 0 ? totalDuration / sessionsData.length : 0;

        document.getElementById('kpi-sessions').textContent = sessionsData.length;
        document.getElementById('kpi-cost').textContent = formatCost(totalCost);
        document.getElementById('kpi-duration').textContent = formatDuration(0, avgDuration);
        document.getElementById('kpi-latency').textContent = formatLatency(avgLatency * 1000);

        renderSessions(sessionsData);
      } catch (error) {
        console.error('Failed to load sessions:', error);
        tbody.innerHTML = '<tr><td colspan="6" class="no-sessions">Failed to load sessions</td></tr>';
      }
    }

    function renderSessions(sessions) {
      const tbody = document.getElementById('sessions-table');

      if (sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-sessions">No sessions found</td></tr>';
        return;
      }

      tbody.innerHTML = sessions.map(session => {
        const progress = getSessionProgressFromTags(session.tags);
        const characters = `${session.mortal || 'Unknown'} + ${session.match || 'Unknown'}`;
        const duration = session.firstSeen && session.lastActive
          ? formatDuration(session.firstSeen, session.lastActive)
          : '-';

        const rows = [`
          <tr class="session-row" onclick="toggleSession('${session.sessionId}')">
            <td>
              <span class="tree-toggle">${expandedSession === session.sessionId ? '&#9660;' : '&#9654;'}</span>
            </td>
            <td class="session-id">${session.sessionId}</td>
            <td>
              <span class="progress-badge ${progress.isComplete ? 'complete' : 'incomplete'}">
                ${progress.label}
              </span>
            </td>
            <td class="characters">${characters}</td>
            <td>${duration}</td>
            <td>
              <a href="conversation.html?sessionId=${session.sessionId}"
                 class="btn btn-primary btn-sm"
                 onclick="event.stopPropagation()">View</a>
            </td>
          </tr>
        `];

        // Add details row if expanded
        if (expandedSession === session.sessionId) {
          rows.push(`
            <tr class="details-row">
              <td></td>
              <td colspan="5">
                <div class="details-grid">
                  <div class="detail-item">
                    <span class="detail-label">Total Cost</span>
                    <span class="detail-value">${formatCost(session.totalCost)}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Avg Latency</span>
                    <span class="detail-value">${formatLatency(session.avgLatency * 1000)}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">First Seen</span>
                    <span class="detail-value">${formatRelativeTime(session.firstSeen)}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Last Active</span>
                    <span class="detail-value">${formatRelativeTime(session.lastActive)}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Traces</span>
                    <span class="detail-value">${session.traceCount}</span>
                  </div>
                </div>
              </td>
            </tr>
          `);
        }

        return rows.join('');
      }).join('');
    }

    function toggleSession(sessionId) {
      if (expandedSession === sessionId) {
        expandedSession = null;
      } else {
        expandedSession = sessionId;
      }
      renderSessions(sessionsData);
    }

    // Search functionality
    document.getElementById('search-input').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = sessionsData.filter(session => {
        if (session.sessionId.toLowerCase().includes(query)) return true;
        if ((session.mortal || '').toLowerCase().includes(query)) return true;
        if ((session.match || '').toLowerCase().includes(query)) return true;
        return false;
      });
      renderSessions(filtered);
    });

    // Initial load
    loadSessions();
  </script>
</body>
</html>
